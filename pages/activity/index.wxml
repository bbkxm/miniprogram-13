<view class="container">
  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-icon"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- æ´»åŠ¨è¯¦æƒ…å†…å®¹ -->
  <block wx:if="{{!loading && activity}}">
    <!-- æ´»åŠ¨å°é¢ -->
    <view class="cover-container">
      <image class="cover-image" src="{{activity.coverImage}}" mode="aspectFill"></image>
      <view class="cover-mask"></view>
      <view class="activity-title">{{activity.title}}</view>
    </view>

    <!-- é¡¶éƒ¨Tabåˆ‡æ¢ -->
    <view class="tabs-container">
      <view 
        wx:for="{{tabs}}" 
        wx:key="id" 
        class="tab {{currentTab === item.id ? 'active' : ''}}"
        data-id="{{item.id}}"
        bindtap="switchTab"
      >
        {{item.name}}
      </view>
    </view>

    <!-- æ´»åŠ¨ä¿¡æ¯Tab -->
    <view wx:if="{{currentTab === 'info'}}" class="info-container">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="info-card">
        <view class="info-section">
          <view class="section-title">æ´»åŠ¨æ—¶é—´</view>
          <view class="section-content">{{activity.startTime}} - {{activity.endTime}}</view>
        </view>
        
        <view class="info-section">
          <view class="section-title">æ´»åŠ¨åœ°ç‚¹</view>
          <view class="section-content">{{activity.location}}</view>
        </view>
        
        <view class="info-section">
          <view class="section-title">æ´»åŠ¨è¯¦æƒ…</view>
          <view class="section-content">{{activity.description}}</view>
        </view>
      </view>
      
      <!-- æ‰“å¡ç‚¹ä¿¡æ¯ -->
      <view class="info-card">
        <view class="card-header">
          <view class="card-title">æ‰“å¡ç‚¹</view>
          <view class="view-map" hover-class="view-map-hover" bindtap="viewMap">æŸ¥çœ‹åœ°å›¾</view>
        </view>
        
        <view class="checkpoint-list">
          <view 
            wx:for="{{activity.checkpoints}}" 
            wx:key="id" 
            class="checkpoint-item"
          >
            <view class="checkpoint-index">{{index + 1}}</view>
            <view class="checkpoint-info">
              <view class="checkpoint-name">{{item.name}}</view>
              <view class="checkpoint-coordinates">
                {{item.coordinates.latitude}}, {{item.coordinates.longitude}}
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å‚ä¸è€…ä¿¡æ¯ -->
      <view class="info-card">
        <view class="card-header">
          <view class="card-title">å‚ä¸è€… ({{activity.participants.length}})</view>
        </view>
        
        <view class="participants-list">
          <view 
            wx:for="{{activity.participants}}" 
            wx:key="id" 
            class="participant-item"
          >
            <image class="participant-avatar" src="{{item.avatar}}"></image>
            <view class="participant-name">{{item.nickname}}</view>
            <view wx:if="{{item.id === activity.creator.id}}" class="creator-badge">åˆ›å»ºè€…</view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ‰“å¡è®°å½•Tab -->
    <view wx:if="{{currentTab === 'checkins'}}" class="checkins-container">
      <!-- ç­›é€‰ä¿¡æ¯ -->
      <view wx:if="{{selectedCheckpointId}}" class="filter-info">
        <text>å·²ç­›é€‰æ‰“å¡ç‚¹: {{checkpointName}}</text>
        <text class="clear-filter" bindtap="clearCheckpointFilter">æ¸…é™¤ç­›é€‰</text>
      </view>
      
      <block wx:if="{{filteredCheckins.length > 0}}">
        <view 
          wx:for="{{filteredCheckins}}" 
          wx:key="id" 
          class="checkin-card"
        >
          <view class="checkin-header">
            <image class="checkin-avatar" src="/images/avatar{{item.userId}}.jpg"></image>
            <view class="checkin-user-info">
              <view class="checkin-nickname">ç”¨æˆ·{{item.userId}}</view>
              <view class="checkin-time">{{item.formattedTime}}</view>
            </view>
          </view>
          
          <view class="checkin-content">
            <view class="checkin-text">{{item.text}}</view>
            
            <view wx:if="{{item.images && item.images.length > 0}}" class="checkin-images">
              <image 
                wx:for="{{item.images}}" 
                wx:for-item="image" 
                wx:key="*this"
                class="checkin-image" 
                src="{{image}}"
                mode="aspectFill"
                data-src="{{image}}"
                data-urls="{{item.images}}"
                bindtap="previewImage"
              ></image>
            </view>
            
            <view class="checkin-location">
              <text class="iconfont icon-location"></text>
              <text>æ‰“å¡ç‚¹: {{activity.checkpoints[item.checkpointId - 1].name}}</text>
            </view>
          </view>
        </view>
      </block>
      
      <view wx:else class="empty-checkins">
        <view class="empty-icon"></view>
        <text>æš‚æ— æ‰“å¡è®°å½•</text>
      </view>
    </view>
    
    <!-- åœ°å›¾Tab -->
    <view wx:if="{{currentTab === 'map'}}" class="map-container">
      <map
        id="activityMap"
        class="activity-map"
        latitude="{{mapMarkers.length > 0 ? mapMarkers[0].latitude : (userLocation ? userLocation.latitude : 39.9)}}"
        longitude="{{mapMarkers.length > 0 ? mapMarkers[0].longitude : (userLocation ? userLocation.longitude : 116.3)}}"
        scale="{{14}}"
        markers="{{mapMarkers}}"
        polyline="{{mapPolyline}}"
        show-location="true"
        bindmarkertap="onMarkerTap"
        bindlabeltap="onMarkerTap"
        bindcallouttap="onMarkerTap"
        bindload="onMapLoad"
      ></map>
      
      <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
      <view class="map-controls">
        <view class="control-btn" bindtap="moveToLocation">
          <view class="control-icon location-icon">ğŸ“</view>
        </view>
        <view class="control-btn" bindtap="refreshLocation">
          <view class="control-icon refresh-icon">ğŸ”„</view>
        </view>
        <view class="control-btn" bindtap="includeAllMarkers">
          <view class="control-icon fit-icon">ğŸ“Œ</view>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="action-bar">
      <button 
        wx:if="{{!hasJoined && !isCreator}}" 
        class="btn-join" 
        bindtap="joinActivity"
      >åŠ å…¥æ´»åŠ¨</button>
      
      <button 
        wx:if="{{hasJoined && !isCreator}}" 
        class="btn-quit" 
        bindtap="quitActivity"
      >é€€å‡ºæ´»åŠ¨</button>
      
      <button 
        wx:if="{{hasJoined || isCreator}}" 
        class="btn-checkin" 
        bindtap="goToCheckin"
      >å»æ‰“å¡</button>
      
      <button 
        open-type="share" 
        class="btn-share"
      >åˆ†äº«æ´»åŠ¨</button>
    </view>
  </block>
</view> 